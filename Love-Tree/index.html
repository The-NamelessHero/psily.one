<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tree of Love â€“ Psily.one</title>
  <link rel="stylesheet" href="../style.css">

  <!-- Vis.js network -->
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <style>
    body { background:#1a0f1f; color:#f8e1ff; font-family:Georgia, serif; margin:0; padding:1em; }
    #network { width:100%; height:60vh; border:2px solid #774da9; border-radius:8px; background:#2d1b3a; }
    #login, #addLink { margin:1em 0; }
    #addLink input { padding:.5em; margin:0 .5em; }
    #addLink button { padding:.5em 1em; }
  </style>
</head>
<body>

  <h1>ðŸŒ³ Tree of Love</h1>
  <div id="login">
    <button id="loginBtn">ðŸ”‘ Log In / Sign Up</button>
    <span id="userLabel"></span>
  </div>

  <div id="addLink" style="display:none;">
    <input id="parentInput" placeholder="Parent name" />
    <input id="childInput"  placeholder="Child name"  />
    <button id="addBtn">âž• Add Link</button>
  </div>

  <div id="network"></div>

  <script>
  // 1) Init Identity
  const identity = netlifyIdentity.init();
  const loginBtn = document.getElementById('loginBtn');
  const userLabel = document.getElementById('userLabel');
  let userNodeId = null;

  loginBtn.onclick = () => identity.open();

  identity.on('login', user => {
    userNodeId = user.email;
    userLabel.textContent = `Logged in as ${userNodeId}`;
    document.getElementById('addLink').style.display = 'block';
    identity.close();
    loadTree();
  });

  // 2) Fetch & render tree
  let network, nodes, edges;
  async function loadTree() {
    const res = await fetch('https://api.sheety.co/YOUR_TOKEN/psily/tree');
    const data = (await res.json()).tree || [];
    nodes = new vis.DataSet();
    edges = new vis.DataSet();

    data.forEach(row => {
      if (!nodes.get(row.parent)) nodes.add({ id: row.parent, label: row.parent });
      if (!nodes.get(row.child))  nodes.add({ id: row.child,  label: row.child  });
      edges.add({ from: row.parent, to: row.child });
    });

    // ensure the current user node exists
    if (userNodeId && !nodes.get(userNodeId)) {
      nodes.add({ id: userNodeId, label: userNodeId, color:{ background:'#ffde7d' }});
    }

    const container = document.getElementById('network');
    const dataSet = { nodes, edges };
    const opts = { physics:{ barnesHut:{ gravitationalConstant:-2000 } } };
    network = new vis.Network(container, dataSet, opts);

    // center on user
    if (userNodeId) {
      network.once('afterDrawing', () => {
        network.focus(userNodeId, { scale:1.3, animation:true });
      });
    }
  }

  // 3) Add new link form
  document.getElementById('addBtn').onclick = async () => {
    const parent = document.getElementById('parentInput').value.trim();
    const child  = document.getElementById('childInput').value.trim();
    if (!parent||!child) return alert('Both names required');

    // 3a) Persist to Sheety
    const res = await fetch('https://api.sheety.co/YOUR_TOKEN/psily/tree', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ tree:{ parent, child, userEmail: userNodeId }} )
    });
    if (!res.ok) return alert('Failed to save link');

    // 3b) Update network in-memory
    if (!nodes.get(parent)) nodes.add({ id: parent, label: parent });
    if (!nodes.get(child))  nodes.add({ id: child,  label: child  });
    edges.add({ from: parent, to: child });

    network.stabilize();                // re-run physics
    network.focus(child, { animation:true });
    document.getElementById('parentInput').value = '';
    document.getElementById('childInput').value  = '';
  };

  </script>
</body>
</html>
