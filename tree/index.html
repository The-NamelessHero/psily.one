<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tree of Love – Psily.one</title>
  <link rel="stylesheet" href="../style.css">
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    body { margin:0; padding:1em; background:#1a0f1f; color:#f8e1ff; font-family:Georgia, serif }
    header { text-align:center; margin-bottom:1em }
    nav a { margin:0 1em; color:#b892ff; text-decoration:none }
    .controls { text-align:center; margin-bottom:1em }
    .controls input, .controls select, .controls button {
      padding:.5em 1em; margin:0 .3em;
      border-radius:4px; border:1px solid #774da9;
      background:#1e1127; color:#fff3ff; font:inherit; cursor:pointer;
    }
    .controls button:disabled { opacity:.5; cursor:default }
    #network {
      width:100%; height:75vh;
      border:2px solid #774da9; border-radius:8px;
      background:#2d1b3a;
    }
    footer { text-align:center; margin-top:1em }
    footer a { color:#b892ff; text-decoration:none }
  </style>
</head>
<body>

  <header>
    <nav>
      <a href="/">🌀 Home</a>
      <a href="/scroll/">✍️ Write a Scroll</a>
      <a href="/library/">🏛️ Library</a>
      <a href="/profile/">👤 Profile</a>
    </nav>
    <h1>🌳 Tree of Love</h1>
    <p>Type two names or click two nodes to add a relationship.</p>
  </header>

  <div class="controls">
    <input id="nameA" placeholder="Name A">
    <select id="relationType">
      <option value="child">👶 Child</option>
      <option value="parent">👪 Parent</option>
      <option value="love">❤️ Love/Friend</option>
    </select>
    <input id="nameB" placeholder="Name B">
    <button id="addBtn">➕ Add Relation</button>
    <button id="deleteBtn" disabled>🗑️ Delete Selected</button>
  </div>

  <div id="network"></div>

  <footer>
    <a href="/">← Back to Psily.one</a>
  </footer>

  <script>
  (function(){
    const OFFSET = 150;  
    // — DataSets
    const nodes = new vis.DataSet();
    const edges = new vis.DataSet();
    let selectedNode = null;

    // — Network
    const network = new vis.Network(
      document.getElementById('network'),
      { nodes, edges },
      {
        physics: {
          enabled: true,
          barnesHut: { gravitationalConstant:-2000, springLength:200, springConstant:0.04 },
          stabilization: { iterations:200 }
        },
        interaction: { dragNodes:true, dragView:true, zoomView:true },
        nodes: {
          shape:'box',
          margin:{top:8,bottom:8,left:12,right:12},
          color:{background:'#774da9',border:'#b892ff'},
          font:{color:'#fff3ff',size:16}
        },
        edges: {
          arrows:{ to:{ enabled:false } },
          color:{ color:'#cfaaff' },
          width:2,
          smooth:{ type:'straight' }
        }
      }
    );

    // — Persistence
    const KEY = 'psily-tree';
    (function load(){
      const saved = localStorage.getItem(KEY);
      if (!saved) return;
      const { n, e } = JSON.parse(saved);
      nodes.add(n); edges.add(e);
    })();
    function save(){
      localStorage.setItem(KEY,
        JSON.stringify({ n: nodes.get(), e: edges.get() })
      );
    }

    // — Helpers
    function createNode(label, refId, side){
      // side: 'left' or 'right'
      const id = nodes.length === 0
        ? 1
        : Math.max(...nodes.get().map(n=>n.id)) + 1;
      let x=0,y=0;
      if (refId) {
        const pos = network.getPosition(refId);
        x = pos.x + (side==='right'? OFFSET : -OFFSET);
        y = pos.y;
      }
      nodes.add({ id, label, x, y, fixed:{x:true,y:true} });
      return id;
    }

    // — Add Relation
    document.getElementById('addBtn').onclick = ()=>{
      const A = document.getElementById('nameA').value.trim();
      const B = document.getElementById('nameB').value.trim();
      const T = document.getElementById('relationType').value;
      if (!A||!B) return alert('Both names required.');

      // find existing
      let a = nodes.get({ filter: n=>n.label===A })[0];
      let b = nodes.get({ filter: n=>n.label===B })[0];
      // create new if missing
      if (!a && !b) {
        a = { id: createNode(A,null,'right') };
        b = { id: createNode(B,a.id,'right') };
      } else if (!a) {
        a = { id: createNode(A,b.id,'left') };
      } else if (!b) {
        b = { id: createNode(B,a.id,'right') };
      }

      // add edge
      const edge = { from:a.id, to:b.id };
      if (T==='love') {
        edge.color = { color:'red' };
        edge.dashes = true;
      }
      edges.add(edge);

      document.getElementById('nameA').value='';
      document.getElementById('nameB').value='';
      save();
    };

    // — Click-to-fill & auto-add
    network.on('click', params=>{
      if (params.nodes.length!==1) return;
      const lbl = nodes.get(params.nodes[0]).label;
      const a = document.getElementById('nameA'),
            b = document.getElementById('nameB');
      if (!a.value) a.value = lbl;
      else if (!b.value) {
        b.value = lbl;
        document.getElementById('addBtn').click();
      }
    });

    // — Select / Delete
    const del = document.getElementById('deleteBtn');
    network.on('selectNode', ({ nodes:sel })=>{
      selectedNode = sel[0];
      del.disabled = false;
    });
    network.on('deselectNode', ()=>{
      selectedNode = null;
      del.disabled = true;
    });
    del.onclick = ()=>{
      if (!selectedNode) return;
      nodes.remove(selectedNode);
      edges.get().filter(e=>e.from===selectedNode||e.to===selectedNode)
                .forEach(e=>edges.remove(e.id));
      del.disabled = true;
      save();
    };

    // — Drag-to-pin
    network.on('dragEnd', ({ nodes:dragged })=>{
      dragged.forEach(id=>{
        const pos = network.getPosition(id);
        nodes.update({ id, x:pos.x, y:pos.y, fixed:{x:true,y:true} });
      });
      save();
    });
  })();
  </script>

</body>
</html>
