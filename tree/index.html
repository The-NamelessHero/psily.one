<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tree of Love – Psily.one</title>
  <link rel="stylesheet" href="../style.css">
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    body {
      margin: 0; padding: 1em;
      background: #1a0f1f; color: #f8e1ff;
      font-family: Georgia, serif;
    }
    header { text-align: center; margin-bottom: 1em; }
    nav a, nav button {
      margin: 0 1em; color: #b892ff;
      text-decoration: none; background: none;
      border: none; font: inherit; cursor: pointer;
    }
    .controls {
      text-align: center; margin-bottom: 1em;
    }
    .controls input,
    .controls select,
    .controls button {
      padding: .5em; margin: 0 .5em;
      border-radius: 4px; border: 1px solid #774da9;
      background: #1e1127; color: #fff3ff; font: inherit;
    }
    #network {
      width: 100%; height: 75vh;
      border: 2px solid #774da9; border-radius: 8px;
      background: #2d1b3a;
    }
    footer { text-align: center; margin-top: 1em; }
    footer a { color: #b892ff; text-decoration: none; }
  </style>
</head>
<body>

  <header>
    <nav>
      <a href="/">🌀 Home</a>
      <a href="/scrolls/">✍️ Write a Scroll</a>
      <a href="/library/">🏛️ Library</a>
      <a href="/profile/">👤 Profile</a>
    </nav>
    <h1 id="tree-title">🌳 Tree of Love</h1>
    <p>Click nodes or type names below to add relationships.</p>
  </header>

  <div class="controls">
    <input id="nameA" placeholder="Name A" />
    <select id="relationType">
      <option value="child">👶 Child link</option>
      <option value="parent">👪 Parent link</option>
      <option value="love">❤️ Love/friend link</option>
    </select>
    <input id="nameB" placeholder="Name B" />
    <button onclick="addRelation()">Add Relation</button>
    <button id="deleteBtn" disabled>🗑️ Delete Selected</button>
  </div>

  <div id="network"></div>

  <footer>
    <a href="/">← Back to Psily.one</a>
  </footer>

  <script>
    // Dark mode toggle
    function toggleDark() {
      document.body.classList.toggle('light-mode');
    }

    // Grab author from URL (for per-user saving)
    const params = new URLSearchParams(location.search);
    const currentUser = params.get('author') || 'guest';
    document.getElementById('tree-title').textContent =
      currentUser === 'guest'
      ? '🌳 Tree of Love'
      : `🌳 ${currentUser}’s Tree of Love`;
    const storageKey = `tree-${currentUser}`;

    // Create empty datasets
    const nodes = new vis.DataSet([]);
    const edges = new vis.DataSet([]);

    // Network config: box nodes, physics enabled for auto-spread
    const container = document.getElementById('network');
    const data = { nodes, edges };
    const options = {
      nodes: {
        shape: 'box',
        margin: 10,
        widthConstraint: { maximum: 200 }
      },
      interaction: {
        dragNodes: true,
        dragView: true,
        zoomView: true
      },
      physics: {
        enabled: true,
        stabilization: { iterations: 200 }
      }
    };
    const network = new vis.Network(container, data, options);
    hierarchical: {
      enabled:           true,
      direction:         'UD',         // top‐down
      sortMethod:        'directed',
      levelSeparation:   200,          // more vertical breathing room
      nodeSpacing:       300,          // more horizontal breathing room
      blockShifting:     false,        // don’t push whole blocks around
      edgeMinimization:  false,        // disable crossing‐reduction
      parentCentralization: false      // leave children where they fall
    }

    // Load saved tree if exists
    const saved = localStorage.getItem(storageKey);
    if (saved) {
      const { savedNodes, savedEdges } = JSON.parse(saved);
      nodes.add(savedNodes);
      edges.add(savedEdges);
    }

    // Helper: find or create node by label
    function getNodeId(label) {
      const existing = nodes.get({ filter: n => n.label === label })[0];
      if (existing) return existing.id;
      const newId = nodes.length === 0
        ? 1
        : Math.max(...nodes.get().map(n => n.id)) + 1;
      nodes.add({ id: newId, label });
      return newId;
    }

    // Save current tree to localStorage
    function saveTree() {
      const savedNodes = nodes.get();
      const savedEdges = edges.get();
      localStorage.setItem(storageKey,
        JSON.stringify({ savedNodes, savedEdges }));
    }

    // Add a new relation manually
    function addRelation() {
      const A = document.getElementById('nameA').value.trim();
      const B = document.getElementById('nameB').value.trim();
      const type = document.getElementById('relationType').value;
      if (!A || !B) return alert('Fill both Name A and Name B');

      const idA = getNodeId(A);
      const idB = getNodeId(B);

      let edgeConfig;
      if (type === 'child') {
        edgeConfig = {
          from: idA, to: idB,
          color: { color: 'grey' },
          dashes: false, width: 2
        };
      } else if (type === 'parent') {
        edgeConfig = {
          from: idA, to: idB,
          color: { color: 'grey' },
          dashes: false, width: 2
        };
      } else { // love
        edgeConfig = {
          from: idA, to: idB,
          color: { color: 'red' },
          dashes: true, width: 2
        };
      }

      edges.add(edgeConfig);
      saveTree();

      // Clear inputs
      document.getElementById('nameA').value = '';
      document.getElementById('nameB').value = '';
    }

    // Click-to-link: fill inputs and auto-add on second click
    network.on('click', params => {
      if (params.nodes.length === 1) {
        const nodeId = params.nodes[0];
        const label = nodes.get(nodeId).label;
        const a = document.getElementById('nameA');
        const b = document.getElementById('nameB');
        if (!a.value) {
          a.value = label;
        } else if (!b.value) {
          b.value = label;
          addRelation();
        }
      }
    });
    let selectedNode = null;

// 1) Listen for clicks in the network
network.on('selectNode', params => {
  selectedNode = params.nodes[0];       // store the id
  document.getElementById('deleteBtn').disabled = false;
});
network.on('deselectNode', () => {
  selectedNode = null;
  document.getElementById('deleteBtn').disabled = true;
});

// 2) Delete button handler
document.getElementById('deleteBtn').onclick = () => {
  if (!selectedNode) return;
  // Remove the node:
  nodes.remove({ id: selectedNode });
  // Remove any edges connected to it:
  edges.forEach(e => {
    if (e.from === selectedNode || e.to === selectedNode) {
      edges.remove({ id: e.id });
    }
  });
  // Clear selection & disable delete
  selectedNode = null;
  document.getElementById('deleteBtn').disabled = true;
};
  </script>

</body>
</html>
