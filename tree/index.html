<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tree of Love â€“ Psily.one</title>
  <link rel="stylesheet" href="../style.css">
  <!-- Vis.js network -->
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body { margin:0; padding:1em; background:#1a0f1f; color:#f8e1ff; font-family:Georgia, serif; }
    header { text-align:center; margin-bottom:1em; }
    nav a { margin:0 1em; color:#b892ff; text-decoration:none; }
    .controls { text-align:center; margin-bottom:1em; }
    .controls input, .controls select, .controls button {
      padding:.5em 1em; margin:0 .3em;
      border-radius:4px; border:1px solid #774da9;
      background:#1e1127; color:#fff3ff; font:inherit; cursor:pointer;
    }
    .controls button:disabled { opacity:.5; cursor:default; }
    #network {
      width:100%; height:75vh;
      border:2px solid #774da9; border-radius:8px;
      background:#2d1b3a;
    }
    footer { text-align:center; margin-top:1em; }
    footer a { color:#b892ff; text-decoration:none; }
  </style>
</head>
<body>

  <header>
    <nav>
      <a href="/">ğŸŒ€ Home</a>
      <a href="/scroll/">âœï¸ Write a Scroll</a>
      <a href="/library/">ğŸ›ï¸ Library</a>
      <a href="/profile/">ğŸ‘¤ Profile</a>
      <button id="authBtn">ğŸ”‘ Log In</button>
    </nav>
    <h1 id="tree-title">ğŸŒ³ Your Tree of Love</h1>
    <p>Click two nodes or type two names to add a relationship.</p>
  </header>

  <div class="controls">
    <input id="nameA" placeholder="Name A">
    <select id="relationType">
      <option value="child">ğŸ‘¶ Child</option>
      <option value="parent">ğŸ‘ª Parent</option>
      <option value="love">â¤ï¸ Love/Friend</option>
    </select>
    <input id="nameB" placeholder="Name B">
    <button id="addBtn">â• Add Relation</button>
    <button id="deleteBtn" disabled>ğŸ—‘ï¸ Delete Selected</button>
    <button id="toggleLock">ğŸ”’ View Only</button>
  </div>

  <div id="network"></div>

  <footer>
    <a href="/">â† Back to Psily.one</a>
  </footer>

  <script>
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // CONFIG: put your Sheety token here!
  const SHEETY_BASE = 'https://api.sheety.co/ac6a020fab729985f64a3f30b8b8763f/psily/tree';
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

 <script>
  // buttons
  const addBtn       = document.getElementById('addBtn');
  const deleteBtn    = document.getElementById('deleteBtn');
  const toggleLockBtn= document.getElementById('toggleLock');

  // state
  let canEdit = false;
  let locked  = false;
  let selectedNode = null;

  // Netlify identity (your existing code)
  netlifyIdentity.init();
  netlifyIdentity.on('login', user => {
    canEdit = true;
    userEmail = user.email;
    authBtn.textContent = 'ğŸšª Log Out';
    loadTree();
  });
  netlifyIdentity.on('logout', () => {
    canEdit = false;
    nodes.clear(); edges.clear();
    authBtn.textContent = 'ğŸ”‘ Log In';
    document.getElementById('tree-title').textContent = 'ğŸŒ³ Your Tree of Love';
  });

  // LOCK / UNLOCK handler
  toggleLockBtn.addEventListener('click', () => {
    locked = !locked;
    // physics on/off
    network.setOptions({ physics: { enabled: !locked } });
    // disable/enable buttons
    addBtn.disabled    = locked || !canEdit;
    deleteBtn.disabled = locked || !canEdit || !selectedNode;
    // update label
    toggleLockBtn.textContent = locked 
      ? 'ğŸ”“ Edit Mode' 
      : 'ğŸ”’ View Only';
  });

  // ADD RELATION handler
  addBtn.addEventListener('click', async () => {
    if (!canEdit)  return alert('Log in to edit your tree!');
    if (locked)    return alert('Unlock to edit your tree!');
    const A = document.getElementById('nameA').value.trim();
    const B = document.getElementById('nameB').value.trim();
    const type = document.getElementById('relationType').value;
    if (!A || !B) return alert('Please fill both Name A and Name B.');
    // your saveRelation() + immediate draw logic here...
    await saveRelation(A, B, type);
    document.getElementById('nameA').value = '';
    document.getElementById('nameB').value = '';
  });

  // SELECT / DELETE handler
  network.on('selectNode', ({ nodes:[nid] }) => {
    selectedNode = nid;
    deleteBtn.disabled = locked || !canEdit ? true : false;
  });
  network.on('deselectNode', () => {
    selectedNode = null;
    deleteBtn.disabled = true;
  });
  deleteBtn.addEventListener('click', async () => {
    if (!canEdit || locked || !selectedNode) return;
    // call DELETE on Sheety then remove
    await deleteRelation(selectedNode);
    nodes.remove(selectedNode);
    edges.get().filter(e=>e.from===selectedNode||e.to===selectedNode)
                .forEach(e=>edges.remove(e.id));
    selectedNode = null;
    deleteBtn.disabled = true;
  });

  // click-to-link (unchanged)
  network.on('click', params => {
    if (!canEdit || locked) return;
    if (params.nodes.length === 1) {
      const lbl = nodes.get(params.nodes[0]).label;
      const a = document.getElementById('nameA');
      const b = document.getElementById('nameB');
      if (!a.value) a.value = lbl;
      else if (!b.value) {
        b.value = lbl;
        addBtn.click();
      }
    }
  });
</script>


</body>
</html>
