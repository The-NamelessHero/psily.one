<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tree of Love â€“ Psily.one</title>
  <link rel="stylesheet" href="../style.css">
  <!-- vis-network -->
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    body { margin:0; padding:1em; background:#1a0f1f; color:#f8e1ff; font-family:Georgia, serif; }
    header { text-align:center; margin-bottom:1em; }
    nav a { margin:0 1em; color:#b892ff; text-decoration:none; }
    .controls { text-align:center; margin-bottom:1em; }
    .controls input, .controls select, .controls button {
      padding:.5em 1em; margin:0 .3em;
      border-radius:4px; border:1px solid #774da9;
      background:#1e1127; color:#fff3ff; font:inherit; cursor:pointer;
    }
    .controls button:disabled { opacity:.5; cursor:default; }
    #network {
      width:100%; height:75vh;
      border:2px solid #774da9; border-radius:8px;
      background:#2d1b3a;
    }
    footer { text-align:center; margin-top:1em; }
    footer a { color:#b892ff; text-decoration:none; }
  </style>
</head>
<body>

  <header>
    <nav>
      <a href="/">ğŸŒ€ Home</a>
      <a href="/scroll/">âœï¸ Write a Scroll</a>
      <a href="/library/">ğŸ›ï¸ Library</a>
      <a href="/profile/">ğŸ‘¤ Profile</a>
    </nav>
    <h1>ğŸŒ³ Tree of Love</h1>
    <p>Click two nodes or type two names to add a relationship.</p>
  </header>

  <div class="controls">
    <input id="nameA" placeholder="Name A">
    <select id="relationType">
      <option value="child">ğŸ‘¶ Child</option>
      <option value="parent">ğŸ‘ª Parent</option>
      <option value="love">â¤ï¸ Love/Friend</option>
    </select>
    <input id="nameB" placeholder="Name B">
    <button id="addBtn">â• Add Relation</button>
    <button id="deleteBtn" disabled>ğŸ—‘ï¸ Delete Selected</button>
    <button id="downloadBtn">ğŸ“„ Download JSON</button>
    <button id="printBtn">ğŸ–¨ï¸ Print</button>
  </div>

  <div id="network"></div>

  <footer>
    <a href="/">â† Back to Psily.one</a>
  </footer>

  <script> 
    (function(){
    const SHEETY_BASE = 'https://api.sheety.co/ac6a020fab729985f64a3f30b8b8763f/psily/tree';
    (function(){
    // Datasets
    const nodes = new vis.DataSet();
    const edges = new vis.DataSet();
    let selectedNode = null;

    // Network
    const network = new vis.Network(
      document.getElementById('network'),
      { nodes, edges },
      {
        physics: {
          enabled:true,
          barnesHut:{ gravitationalConstant:-2000, springLength:200, springConstant:0.04 },
          stabilization:{ iterations:200 }
        },
        interaction:{ dragNodes:true, dragView:true, zoomView:true },
        nodes:{
          shape:'box',
          margin:{top:8,bottom:8,left:12,right:12},
          color:{background:'#774da9',border:'#b892ff'},
          font:{color:'#fff3ff',size:16}
        },
        edges:{
          arrows:{ to:{ enabled:false }},
          color:{ color:'#cfaaff' },
          width:2,
          smooth:{ type:'straight' }
        }
      }
    );

 
async function loadTreeFromSheet(){
  const res  = await fetch(`${SHEETY_BASE}?userEmail=${encodeURIComponent(userEmail)}`);
  const data = (await res.json()).tree || [];
  nodes.clear(); edges.clear();
  data.forEach(r=>{ /* add nodes/edges here */ });
}

// Example: save one relation via POST
async function saveRelation(parent, child, type, x,y,cx,cy){
  const payload = { tree:{ parent,child,type,userEmail,x,y,cx,cy } };
  const res = await fetch(SHEETY_BASE, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });
  return (await res.json()).tree;
}


    // Helpers
    function getNodeId(label){
      let found = nodes.get({ filter: x=>x.label===label })[0];
      if (found) return found.id;
      const id = nodes.length===0?1:Math.max(...nodes.get().map(n=>n.id))+1;
      nodes.add({ id, label });
      return id;
    }

    // Add Relation
    document.getElementById('addBtn').onclick = ()=>{
      const A = document.getElementById('nameA').value.trim();
      const B = document.getElementById('nameB').value.trim();
      const T = document.getElementById('relationType').value;
      if(!A||!B) return alert('Both names required.');
      const idA = getNodeId(A), idB = getNodeId(B);
      const cfg = { from:idA, to:idB };
      if (T==='love'){ cfg.color={color:'red'}; cfg.dashes=true; }
      edges.add(cfg);
      document.getElementById('nameA').value = '';
      document.getElementById('nameB').value = '';
      save();
    };

    // Click-to-fill & auto-add
    document.getElementById('network').addEventListener('click', e=>{
      const sel = network.getSelectedNodes();
      if (sel.length!==1) return;
      const lbl = nodes.get(sel[0]).label;
      const a = document.getElementById('nameA'), b = document.getElementById('nameB');
      if (!a.value) a.value = lbl;
      else if (!b.value){ b.value = lbl; document.getElementById('addBtn').click(); }
    });

    // Select / Delete
    network.on('selectNode', params=>{
      selectedNode = params.nodes[0];
      document.getElementById('deleteBtn').disabled = false;
    });
    network.on('deselectNode', ()=>{
      selectedNode = null;
      document.getElementById('deleteBtn').disabled = true;
    });
    document.getElementById('deleteBtn').onclick = ()=>{
      if (!selectedNode) return;
      nodes.remove(selectedNode);
      edges.get().filter(e=>e.from===selectedNode||e.to===selectedNode)
                .forEach(e=>edges.remove(e.id));
      selectedNode = null;
      document.getElementById('deleteBtn').disabled = true;
      save();
    };

    // Drag-to-pin & save
    network.on('dragEnd', ({ nodes:dragged })=>{
      dragged.forEach(id=>{
        const pos = network.getPosition(id);
        nodes.update({ id, x:pos.x, y:pos.y, fixed:{x:true,y:true} });
      });
      save();
    });

    // Download JSON
    document.getElementById('downloadBtn').onclick = ()=>{
      const dataStr = JSON.stringify({ nodes:nodes.get(), edges:edges.get() }, null, 2);
      const blob = new Blob([dataStr], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'psily-tree.json';
      a.click(); URL.revokeObjectURL(url);
    };

    // Print
    document.getElementById('printBtn').onclick = () => window.print();

  })();
  </script>

</body>
</html>
