<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tree of Love â€“ Psily.one</title>
  <link rel="stylesheet" href="../style.css">
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    body { margin:0; padding:1em; background:#1a0f1f; color:#f8e1ff; font-family:Georgia, serif; }
    header { text-align:center; margin-bottom:1em; }
    nav a { margin:0 1em; color:#b892ff; text-decoration:none; }
    .controls { text-align:center; margin-bottom:1em; }
    .controls input, .controls select, .controls button {
      padding:.5em 1em; margin:0 .3em;
      border-radius:4px; border:1px solid #774da9;
      background:#1e1127; color:#fff3ff; font:inherit; cursor:pointer;
    }
    .controls button:disabled { opacity:.5; cursor:default; }
    #network {
      width:100%; height:75vh;
      border:2px solid #774da9; border-radius:8px;
      background:#2d1b3a;
    }
    footer { text-align:center; margin-top:1em; }
    footer a { color:#b892ff; text-decoration:none; }
  </style>
</head>
<body>

  <header>
    <nav>
      <a href="/">ğŸŒ€ Home</a>
      <a href="/scroll/">âœï¸ Write a Scroll</a>
      <a href="/library/">ğŸ›ï¸ Library</a>
      <a href="/profile/">ğŸ‘¤ Profile</a>
    </nav>
    <h1 id="tree-title">ğŸŒ³ Tree of Love</h1>
    <p>Click two nodes or type two names to add a relationship.</p>
  </header>

  <div class="controls">
    <input id="nameA" placeholder="Name A">
    <select id="relationType">
      <option value="child">ğŸ‘¶ Child</option>
      <option value="parent">ğŸ‘ª Parent</option>
      <option value="love">â¤ï¸ Love/Friend</option>
    </select>
    <input id="nameB" placeholder="Name B">
    <button id="addBtn">â• Add Relation</button>
    <button id="deleteBtn" disabled>ğŸ—‘ï¸ Delete Selected</button>
  </div>

  <div id="network"></div>

  <footer>
    <a href="/">â† Back to Psily.one</a>
  </footer>

  <script>
    netlifyIdentity.init();
    let userEmail = null;
    let canEdit   = false;

    netlifyIdentity.on('login', user => {
    userEmail = user.email;
    canEdit   = true;
    loadTreeFromSheet();
  });
    netlifyIdentity.on('logout', () => {
    userEmail = null;
    canEdit   = false;
    nodes.clear(); edges.clear();
  });
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Setup user & storage
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const params = new URLSearchParams(location.search);
    const user = params.get('author') || 'Guest';
    document.getElementById('tree-title').textContent = `ğŸŒ³ ${user}'s Tree of Love`;
    const storageKey = `tree-${user}`;

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Create DataSets
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const nodes = new vis.DataSet();
    const edges = new vis.DataSet();

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Network options: physics + free layout, no arrows
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const options = {
      physics: {
        enabled: true,
        barnesHut: { gravitationalConstant:-3000, springConstant:0.05, springLength:200 },
        stabilization: { iterations:200 }
      },
      interaction: {
        dragNodes: true,
        dragView:  true,
        zoomView:  true
      },
      nodes: {
        shape: 'box',
        margin: { top:8, bottom:8, left:12, right:12 },
        color: { background:'#774da9', border:'#b892ff' },
        font: { color:'#fff3ff', size:16 }
      },
      edges: {
        arrows: { to:{ enabled:false } },
        color:  { color:'#cfaaff' },
        width: 2,
        smooth: { type:'straight' }
      }
    };
    const network = new vis.Network(
      document.getElementById('network'),
      { nodes, edges },
      options
    );

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Load saved tree
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    (function loadTree(){
      const saved = localStorage.getItem(storageKey);
      if (!saved) return;
      const { savedNodes, savedEdges } = JSON.parse(saved);
      nodes.add(savedNodes);
      edges.add(savedEdges);
    })();

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Helpers
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function saveTree(){
      localStorage.setItem(storageKey, JSON.stringify({
        savedNodes: nodes.get(),
        savedEdges: edges.get()
      }));
    }
    function getNodeId(label){
      const found = nodes.get({ filter: n=> n.label===label })[0];
      if (found) return found.id;
      const newId = nodes.length===0 ? 1 : Math.max(...nodes.get().map(n=>n.id))+1;
      nodes.add({ id:newId, label });
      return newId;
    }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Add Relation
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    document.getElementById('addBtn').onclick = () => {
      const A = document.getElementById('nameA').value.trim();
      const B = document.getElementById('nameB').value.trim();
      const type = document.getElementById('relationType').value;
      if (!A||!B) return alert('Please fill both Name A and Name B.');

      const idA = getNodeId(A);
      const idB = getNodeId(B);

      // build edge
      const edge = { from:idA, to:idB };
      if (type==='love') {
        edge.color = { color:'red' };
        edge.dashes = true;
      }
      edges.add(edge);

      // clear & save
      document.getElementById('nameA').value='';
      document.getElementById('nameB').value='';
      saveTree();
    };

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Click-to-fill
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    network.on('click', params=>{
      if (params.nodes.length!==1) return;
      const label = nodes.get(params.nodes[0]).label;
      const a = document.getElementById('nameA'),
            b = document.getElementById('nameB');
      if (!a.value)          a.value=label;
      else if (!b.value) { b.value=label; document.getElementById('addBtn').click(); }
    });

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Delete Selected
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    let selected=null;
    network.on('selectNode',  p=> { selected=p.nodes[0]; document.getElementById('deleteBtn').disabled=false; });
    network.on('deselectNode',() => { selected=null; document.getElementById('deleteBtn').disabled=true; });
    document.getElementById('deleteBtn').onclick = () => {
      if (!selected) return;
      nodes.remove(selected);
      edges.get().forEach(e=>{
        if (e.from===selected||e.to===selected) edges.remove(e.id);
      });
      selected=null;
      document.getElementById('deleteBtn').disabled=true;
      saveTree();
    };

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Drag-to-pin + save
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    network.on('dragEnd', params=> {
      params.nodes.forEach(id=>{
        const pos = network.getPosition(id);
        nodes.update({ id, x:pos.x, y:pos.y, fixed:{x:true,y:true} });
      });
      saveTree();
    });
  </script>

</body>
</html>
