<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tree of Love â€“ Psily.one</title>
  <link rel="stylesheet" href="../style.css">
  <!-- Vis.js network -->
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body { margin:0; padding:1em; background:#1a0f1f; color:#f8e1ff; font-family:Georgia, serif; }
    header { text-align:center; margin-bottom:1em; }
    nav a { margin:0 1em; color:#b892ff; text-decoration:none; }
    .controls { text-align:center; margin-bottom:1em; }
    .controls input, .controls select, .controls button {
      padding:.5em 1em; margin:0 .3em;
      border-radius:4px; border:1px solid #774da9;
      background:#1e1127; color:#fff3ff; font:inherit; cursor:pointer;
    }
    .controls button:disabled { opacity:.5; cursor:default; }
    #network {
      width:100%; height:75vh;
      border:2px solid #774da9; border-radius:8px;
      background:#2d1b3a;
    }
    footer { text-align:center; margin-top:1em; }
    footer a { color:#b892ff; text-decoration:none; }
  </style>
</head>
<body>

  <header>
    <nav>
      <a href="/">ğŸŒ€ Home</a>
      <a href="/scroll/">âœï¸ Write a Scroll</a>
      <a href="/library/">ğŸ›ï¸ Library</a>
      <a href="/profile/">ğŸ‘¤ Profile</a>
      <button id="authBtn">ğŸ”‘ Log In</button>
    </nav>
    <h1 id="tree-title">ğŸŒ³ Your Tree of Love</h1>
    <p>Click two nodes or type two names to add a relationship.</p>
  </header>

  <div class="controls">
    <input id="nameA" placeholder="Name A">
    <select id="relationType">
      <option value="child">ğŸ‘¶ Child</option>
      <option value="parent">ğŸ‘ª Parent</option>
      <option value="love">â¤ï¸ Love/Friend</option>
    </select>
    <input id="nameB" placeholder="Name B">
    <button id="addBtn">â• Add Relation</button>
    <button id="deleteBtn" disabled>ğŸ—‘ï¸ Delete Selected</button>
    <button id="toggleLock">ğŸ”’ View Only</button>
  </div>

  <div id="network"></div>

  <footer>
    <a href="/">â† Back to Psily.one</a>
  </footer>

  <script>
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
  // CONFIG: put your Sheety token here!
  const SHEETY_BASE = 'https://api.sheety.co/ac6a020fab729985f64a3f30b8b8763f/psily/tree';
  // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

  let userEmail = null;
  let canEdit   = false;
  let locked    = false;
  let selected  = null;

  // Initialize Netlify Identity
  netlifyIdentity.init();
  const authBtn = document.getElementById('authBtn');
  authBtn.onclick = () => {
    if (!userEmail) netlifyIdentity.open();
    else           netlifyIdentity.logout();
  };
  netlifyIdentity.on('login', user => {
    userEmail = user.email;
    canEdit   = true;
    authBtn.textContent = 'ğŸšª Log Out';
    loadTree();
  });
  netlifyIdentity.on('logout', () => {
    userEmail = null;
    canEdit   = false;
    authBtn.textContent = 'ğŸ”‘ Log In';
    nodes.clear(); edges.clear();
    document.getElementById('tree-title').textContent = 'ğŸŒ³ Your Tree of Love';
  });

  // Setup Vis.js
  const nodes   = new vis.DataSet();
  const edges   = new vis.DataSet();
  const container = document.getElementById('network');
  const network = new vis.Network(container, { nodes, edges }, {
    nodes: {
      shape: 'box',
      margin: 10,
      color: { background:'#774da9', border:'#b892ff', highlight:{background:'#b892ff'} },
      font: { color:'#fff3ff' }
    },
    edges: {
      arrows: false,
      smooth: { type:'straight' }
    },
    interaction: { dragNodes:true, zoomView:true },
    physics: { enabled: true, stabilization:{ iterations:200 } }
  });

  // Toggle edit/view mode
  document.getElementById('toggleLock').onclick = () => {
    locked = !locked; 
    network.setOptions({ physics:{ enabled: !locked } });
    [ 'addBtn','deleteBtn' ].forEach(id => {
      document.getElementById(id).disabled = locked || !canEdit;
    });
    document.getElementById('toggleLock').textContent = locked ? 'ğŸ”“ Edit Mode' : 'ğŸ”’ View Only';
  };

  // Helpers
  function getNodeId(label) {
    let found = nodes.get({ filter: n=>n.label===label })[0];
    if (found) return found.id;
    let id = nodes.length === 0 ? 1 : Math.max(...nodes.get().map(n=>n.id)) + 1;
    nodes.add({ id, label });
    return id;
  }

  function saveRelation(parent, child, type, id=null) {
    // POST new or PUT existing
    const payload = { tree: { parent, child, type, userEmail } };
    let url = SHEETY_BASE;
    let method = 'POST';
    if (id) { url += `/${id}`; method = 'PUT'; payload.tree.id = id; }
    return fetch(url, {
      method, headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    }).then(r=>r.json());
  }

  async function loadTree() {
    if (!canEdit) return;
    // fetch only this userâ€™s tree
    const res = await fetch(`${SHEETY_BASE}?userEmail=${encodeURIComponent(userEmail)}`);
    const rows = (await res.json()).tree || [];
    nodes.clear(); edges.clear();
    rows.forEach(r => {
      // add nodes
      const pid = getNodeId(r.parent);
      const cid = getNodeId(r.child);
      // add edge
      edges.add({
        id: r.id,
        from: pid,
        to: cid,
        dashes: r.type==='love',
        color: { color: r.type==='love' ? 'red' : 'grey' },
        width: 2
      });
    });
    document.getElementById('tree-title').textContent = `ğŸŒ³ ${userEmail}'s Tree of Love`;
  }

  // Add Relation
  document.getElementById('addBtn').onclick = async () => {
    if (!canEdit || locked) return alert('Log in and unlock to edit.');
    const A = document.getElementById('nameA').value.trim();
    const B = document.getElementById('nameB').value.trim();
    const type = document.getElementById('relationType').value;
    if (!A||!B) return alert('Fill both names.');
    const { tree } = await saveRelation(A, B, type);
    // reflect immediately
    const pid = getNodeId(tree.parent), cid = getNodeId(tree.child);
    edges.add({
      id: tree.id, from: pid, to: cid,
      dashes: tree.type==='love',
      color:{ color: tree.type==='love'?'red':'grey' },
      width:2
    });
    [ 'nameA','nameB' ].forEach(id=>document.getElementById(id).value='');
  };

  // Click to delete
  let sel = null;
  network.on('selectNode', ({ nodes: [nid] }) => {
    sel = nid;
    document.getElementById('deleteBtn').disabled = false;
  });
  network.on('deselectNode', () => {
    sel = null;
    document.getElementById('deleteBtn').disabled = true;
  });
  document.getElementById('deleteBtn').onclick = async () => {
    if (!canEdit||locked||!sel) return;
    // remove all edges touching sel
    const toRemove = edges.get().filter(e => e.from===sel||e.to===sel);
    // delete each from Sheety
    await Promise.all(toRemove.map(e =>
      fetch(`${SHEETY_BASE}/${e.id}`, { method:'DELETE' })
    ));
    edges.remove(toRemove.map(e=>e.id));
    nodes.remove(sel);
    sel = null;
    document.getElementById('deleteBtn').disabled = true;
  };

  // Clickâ€toâ€link helper
  network.on('click', params => {
    if (!canEdit||locked) return;
    if (params.nodes.length===1) {
      const lbl = nodes.get(params.nodes[0]).label;
      const A = document.getElementById('nameA'),
            B = document.getElementById('nameB');
      if (!A.value) A.value = lbl;
      else if (!B.value) { B.value = lbl; document.getElementById('addBtn').click(); }
    }
  });

  // On load, if already logged in
  if (netlifyIdentity.currentUser()) {
    netlifyIdentity.on('init', user => {
      if (user) {
        userEmail = user.email;
        canEdit   = true;
        authBtn.textContent = 'ğŸšª Log Out';
        loadTree();
      }
    });
  }
  </script>

</body>
</html>
