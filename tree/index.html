<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tree of Love â€“ Psily.one</title>
  <link rel="stylesheet" href="../style.css">
  <!-- vis-network -->
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <style>
    body { margin:0; padding:1em; background:#1a0f1f; color:#f8e1ff; font-family:Georgia, serif }
    header { text-align:center; margin-bottom:1em }
    nav a { margin:0 1em; color:#b892ff; text-decoration:none }
    .controls { text-align:center; margin-bottom:1em }
    .controls input,
    .controls select,
    .controls button {
      padding:.5em 1em; margin:0 .3em;
      border-radius:4px; border:1px solid #774da9;
      background:#1e1127; color:#fff3ff; font:inherit; cursor:pointer;
    }
    .controls button:disabled { opacity:.5; cursor:default }
    #network {
      width:100%; height:75vh;
      border:2px solid #774da9; border-radius:8px;
      background:#2d1b3a;
    }
    footer { text-align:center; margin-top:1em }
    footer a { color:#b892ff; text-decoration:none }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="/">ğŸŒ€ Home</a>
      <a href="/scroll/">âœï¸ Write a Scroll</a>
      <a href="/library/">ğŸ›ï¸ Library</a>
      <a href="/profile/">ğŸ‘¤ Profile</a>
    </nav>
    <h1>ğŸŒ³ Tree of Love</h1>
    <p>Click two nodes or type two names to add a relationship.</p>
  </header>

  <div class="controls">
    <input id="nameA" placeholder="Name A">
    <select id="relationType">
      <option value="child">ğŸ‘¶ Child</option>
      <option value="parent">ğŸ‘ª Parent</option>
      <option value="love">â¤ï¸ Love/Friend</option>
    </select>
    <input id="nameB" placeholder="Name B">
    <button id="addBtn">â• Add Relation</button>
    <button id="deleteBtn" disabled>ğŸ—‘ï¸ Delete Selected</button>
  </div>

  <div id="network"></div>

  <footer>
    <a href="/">â† Back to Psily.one</a>
  </footer>

  <script>
  (function(){
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1) YOUR SHEETY BASE
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SHEETY_BASE = 'https://api.sheety.co/YOUR_SHEETY_TOKEN/psily/tree';

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2) vis.js setup
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const nodes = new vis.DataSet();
    const edges = new vis.DataSet();
    const network = new vis.Network(
      document.getElementById('network'),
      { nodes, edges },
      {
        physics: {
          enabled:true,
          barnesHut:{ gravitationalConstant:-2000, springLength:200, springConstant:0.04 },
          stabilization:{ iterations:200 }
        },
        interaction:{ dragNodes:true, dragView:true, zoomView:true },
        nodes:{
          shape:'box',
          margin:{top:8,bottom:8,left:12,right:12},
          color:{background:'#774da9',border:'#b892ff'},
          font:{color:'#fff3ff',size:16}
        },
        edges:{
          arrows:{to:{enabled:false}},
          color:{color:'#cfaaff'},
          width:2,
          smooth:{type:'straight'}
        }
      }
    );

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 3) Helpers
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getNodeId(label){
      const found = nodes.get({ filter: n => n.label === label })[0];
      if (found) return found.id;
      const id = nodes.length === 0
        ? 1
        : Math.max(...nodes.get().map(n=>n.id)) + 1;
      nodes.add({ id, label });
      return id;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 4) Load from Sheety
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadTree(){
      const res  = await fetch(SHEETY_BASE);
      const list = (await res.json()).tree || [];
      nodes.clear(); edges.clear();
      list.forEach(r => {
        // each row maps to one parentâ†’child edge
        const pid = 'p'+r.id, cid = 'c'+r.id;
        nodes.add({ id:pid, label:r.parent, x:r.x, y:r.y, fixed:{x:!!r.x,y:!!r.y} });
        nodes.add({ id:cid, label:r.child,  x:r.cx, y:r.cy, fixed:{x:!!r.cx,y:!!r.cy} });
        edges.add({
          id: r.id,
          from: pid,
          to:   cid,
          color: { color: r.type==='love' ? 'red' : '#cfaaff' },
          dashes: r.type === 'love'
        });
      });
    }
    loadTree();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 5) Save new relation
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function saveRelation(parent, child, type, x,y,cx,cy){
      const payload = {
        tree: { parent, child, type, x, y, cx, cy }
      };
      const res = await fetch(SHEETY_BASE, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      return (await res.json()).tree;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 6) Delete relation
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function deleteRelation(id){
      await fetch(`${SHEETY_BASE}/${id}`, { method:'DELETE' });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 7) Add Relation UI
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('addBtn').onclick = async () => {
      const A = document.getElementById('nameA').value.trim();
      const B = document.getElementById('nameB').value.trim();
      const T = document.getElementById('relationType').value;
      if (!A || !B) return alert('Both names are required.');

      // get or create nodes
      const idA = getNodeId(A);
      const idB = getNodeId(B);

      // grab their current positions
      const posA = network.getPosition(idA);
      const posB = network.getPosition(idB);

      // send to Sheety
      const row = await saveRelation(A,B,T,posA.x,posA.y,posB.x,posB.y);

      // reflect back into vis
      const pid = 'p'+row.id, cid = 'c'+row.id;
      nodes.update({ id:pid, label:row.parent, x:row.x, y:row.y, fixed:{x:true,y:true} });
      nodes.update({ id:cid, label:row.child,  x:row.cx, y:row.cy, fixed:{x:true,y:true} });
      edges.add({
        id:     row.id,
        from:   pid,
        to:     cid,
        color:  { color: row.type==='love' ? 'red' : '#cfaaff' },
        dashes: row.type==='love'
      });

      document.getElementById('nameA').value = '';
      document.getElementById('nameB').value = '';
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 8) Click-to-fill & auto-add
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    network.on('click', params => {
      if (params.nodes.length !== 1) return;
      const lbl = nodes.get(params.nodes[0]).label;
      const a = document.getElementById('nameA'),
            b = document.getElementById('nameB');
      if (!a.value) a.value = lbl;
      else if (!b.value) {
        b.value = lbl;
        document.getElementById('addBtn').click();
      }
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 9) Delete Selected
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let selected = null;
    network.on('selectNode', ({ nodes }) => {
      selected = nodes[0];
      document.getElementById('deleteBtn').disabled = false;
    });
    network.on('deselectNode', () => {
      selected = null;
      document.getElementById('deleteBtn').disabled = true;
    });
    document.getElementById('deleteBtn').onclick = async () => {
      if (!selected) return;
      const relId = parseInt(selected.slice(1),10);
      await deleteRelation(relId);
      nodes.remove(selected);
      edges.get().filter(e=>e.id===relId).forEach(e=>edges.remove(e.id));
      selected = null;
      document.getElementById('deleteBtn').disabled = true;
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 10) Drag-to-pin & update
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    network.on('dragEnd', async ({ nodes:dragged }) => {
      for (const nid of dragged) {
        const relId = parseInt(nid.slice(1),10);
        if (!relId) continue;
        const pos = network.getPosition(nid);
        const body = { tree:{} };
        if (nid.startsWith('p')) { body.tree.x  = pos.x; body.tree.y = pos.y; }
        else                     { body.tree.cx = pos.x; body.tree.cy = pos.y; }
        await fetch(`${SHEETY_BASE}/${relId}`, {
          method:'PUT',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
      }
    });
  })();
  </script>
</body>
</html>
