<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tree of Love â€“ Psily.one</title>
  <link rel="stylesheet" href="../style.css">
  <!-- vis-network -->
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <!-- Netlify Identity -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body { margin:0; padding:1em; background:#1a0f1f; color:#f8e1ff; font-family:Georgia, serif; }
    header { text-align:center; margin-bottom:1em; }
    nav a, nav button { margin:0 1em; color:#b892ff; background:none; border:none; cursor:pointer; font:inherit; }
    .controls { text-align:center; margin-bottom:1em; }
    .controls input, .controls select, .controls button {
      padding:.5em 1em; margin:0 .3em;
      border-radius:4px; border:1px solid #774da9;
      background:#1e1127; color:#fff3ff; font:inherit; cursor:pointer;
    }
    .controls button:disabled { opacity:.5; cursor:default; }
    #network { width:100%; height:75vh; border:2px solid #774da9; border-radius:8px; background:#2d1b3a; }
    footer { text-align:center; margin-top:1em; }
    footer a { color:#b892ff; text-decoration:none; }
  </style>
</head>
<body>

  <header>
    <nav>
      <a href="/">ğŸŒ€ Home</a>
      <a href="/scroll/">âœï¸ Write a Scroll</a>
      <a href="/library/">ğŸ›ï¸ Library</a>
      <a href="/profile/">ğŸ‘¤ Profile</a>
      <button id="authBtn">ğŸ”‘ Log In</button>
    </nav>
    <h1 id="tree-title">ğŸŒ³ Tree of Love</h1>
    <p>Click two nodes or type two names to add a relationship.</p>
  </header>

  <div class="controls">
    <input id="nameA" placeholder="Name A">
    <select id="relationType">
      <option value="child">ğŸ‘¶ Child</option>
      <option value="parent">ğŸ‘ª Parent</option>
      <option value="love">â¤ï¸ Love/Friend</option>
    </select>
    <input id="nameB" placeholder="Name B">
    <button id="addBtn" disabled>â• Add Relation</button>
    <button id="deleteBtn" disabled>ğŸ—‘ï¸ Delete Selected</button>
    <button id="toggleLock" disabled>ğŸ”’ View Only</button>
  </div>

  <div id="network"></div>

  <footer>
    <a href="/">â† Back to Psily.one</a>
  </footer>

  <script>
  (function(){
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // CONFIG
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const SHEETY_BASE = 'https://api.sheety.co/ac6a020fab729985f64a3f30b8b8763f/psily/tree';
    const authBtn     = document.getElementById('authBtn');
    const addBtn      = document.getElementById('addBtn');
    const deleteBtn   = document.getElementById('deleteBtn');
    const toggleLock  = document.getElementById('toggleLock');
    const nameAInput  = document.getElementById('nameA');
    const nameBInput  = document.getElementById('nameB');
    const relType     = document.getElementById('relationType');
    let userEmail     = null;
    let canEdit       = false;
    let locked        = true;
    let selectedNode  = null;

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // INIT Netlify Identity
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    netlifyIdentity.init();
    authBtn.onclick = () => {
      if (!canEdit) netlifyIdentity.open();
      else netlifyIdentity.logout();
    };
    netlifyIdentity.on('login', user => {
      userEmail = user.email;
      canEdit   = true;
      locked     = false;
      authBtn.textContent    = 'ğŸšª Log Out';
      document.getElementById('tree-title').textContent = `ğŸŒ³ ${userEmail}'s Tree of Love`;
      enableControls();
      loadTreeFromSheet();
    });
    netlifyIdentity.on('logout', () => {
      canEdit = false;
      userEmail = null;
      authBtn.textContent    = 'ğŸ”‘ Log In';
      document.getElementById('tree-title').textContent = 'ğŸŒ³ Tree of Love';
      nodes.clear(); edges.clear();
      disableControls();
    });

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Setup vis DataSets and Network
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const nodes = new vis.DataSet();
    const edges = new vis.DataSet();
    const network = new vis.Network(
      document.getElementById('network'),
      { nodes, edges },
      {
        physics: {
          enabled: true,
          barnesHut: { gravitationalConstant:-3000, springConstant:0.05, springLength:200 },
          stabilization: { iterations:200 }
        },
        interaction: { dragNodes:true, dragView:true, zoomView:true },
        nodes: {
          shape:'box',
          margin:{top:8,bottom:8,left:12,right:12},
          color:{background:'#774da9',border:'#b892ff'},
          font:{color:'#fff3ff',size:16}
        },
        edges: {
          arrows:{to:{enabled:false}},
          color:{color:'#cfaaff'},
          width:2,
          smooth:{type:'straight'}
        }
      }
    );

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Enable/Disable Controls
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function enableControls(){
      [addBtn, deleteBtn, toggleLock].forEach(b=>b.disabled=false);
      locked = false;
      toggleLock.textContent = 'ğŸ”’ View Only';
    }
    function disableControls(){
      [addBtn, deleteBtn, toggleLock].forEach(b=>b.disabled=true);
      locked = true;
    }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Load Tree from Sheety
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    async function loadTreeFromSheet(){
      if (!userEmail) return;
      nodes.clear(); edges.clear();
      const res  = await fetch(`${SHEETY_BASE}?userEmail=${encodeURIComponent(userEmail)}`);
      const data = (await res.json()).tree || [];
      data.forEach(r => {
        // add parent & child nodes
        const pId = 'p'+r.id, cId = 'c'+r.id;
        nodes.add({ id:pId, label:r.parent, x:r.x, y:r.y, fixed:{x:!!r.x,y:!!r.y} });
        nodes.add({ id:cId, label:r.child,  x:r.cx, y:r.cy, fixed:{x:!!r.cx,y:!!r.cy} });
        // add edge
        edges.add({
          id:r.id,
          from:pId, to:cId,
          color: { color: r.type==='love'?'red':'#cfaaff' },
          dashes: r.type==='love'
        });
      });
    }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Save one relation to Sheety
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    async function saveRelation(parent, child, type, x, y, cx, cy){
      const body = {
        tree: { parent, child, type, userEmail, x, y, cx, cy }
      };
      const res = await fetch(SHEETY_BASE, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      return (await res.json()).tree;
    }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Delete one relation in Sheety
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    async function deleteRelation(id){
      await fetch(`${SHEETY_BASE}/${id}`, { method:'DELETE' });
    }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Helper: get or create node
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function getNodeIds(parent, child){
      let p = nodes.get({ filter:n=>n.label===parent })[0];
      if (!p) p = { id: nodes.add({ label:parent }) };
      let c = nodes.get({ filter:n=>n.label===child })[0];
      if (!c) c = { id: nodes.add({ label:child }) };
      return [p.id, c.id];
    }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Add Relation Handler
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    addBtn.onclick = async()=>{
      if (!canEdit||locked) return;
      const A = nameAInput.value.trim();
      const B = nameBInput.value.trim();
      const T = relType.value;
      if (!A||!B) return alert('Fill both names.');
      // get click pos of A & B (or default center)
      const posA = network.getPosition(getNodeIds(A,B)[0]);
      const posB = network.getPosition(getNodeIds(A,B)[1]);
      const row  = await saveRelation(A,B,T,posA.x,posA.y,posB.x,posB.y);
      const pid  = 'p'+row.id, cid = 'c'+row.id;
      nodes.update({ id:pid, label:row.parent, x:row.x,y:row.y, fixed:{x:true,y:true} });
      nodes.update({ id:cid, label:row.child,  x:row.cx,y:row.cy, fixed:{x:true,y:true} });
      edges.add({ id:row.id, from:pid, to:cid,
        color:{ color: row.type==='love'?'red':'#cfaaff' },
        dashes: row.type==='love'
      });
      nameAInput.value = ''; nameBInput.value = '';
    };

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Click-to-fill / auto-add on second click
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    let lastClick = null;
    network.on('click', ({ nodes:sel })=>{
      if (!canEdit||locked) return;
      if (sel.length!==1) return;
      const lbl = nodes.get(sel[0]).label;
      if (!nameAInput.value) nameAInput.value = lbl;
      else if (!nameBInput.value) {
        nameBInput.value = lbl;
        addBtn.click();
      }
    });

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Delete Selected Handler
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    network.on('selectNode', ({ nodes:sel })=>{
      if (!canEdit||locked) return;
      selectedNode = sel[0];
      deleteBtn.disabled = false;
    });
    network.on('deselectNode', ()=>{
      selectedNode = null;
      deleteBtn.disabled = true;
    });
    deleteBtn.onclick = async()=>{
      if (!selectedNode||!canEdit||locked) return;
      const relId = Number(selectedNode.slice(1)); // strip p/c prefix
      await deleteRelation(relId);
      nodes.remove(selectedNode);
      edges.get().filter(e=>e.id===relId).forEach(e=>edges.remove(e.id));
      deleteBtn.disabled = true;
    };

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Drag-to-pin + update Sheety
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    network.on('dragEnd', async({ nodes:dragged })=>{
      if (!canEdit) return;
      for (const nid of dragged){
        const rowId = Number(nid.slice(1));
        if (!rowId) continue;
        const pos = network.getPosition(nid);
        const isParent = nid.startsWith('p');
        // build update payload
        const body = { tree:{} };
        if (isParent) { body.tree.x = pos.x; body.tree.y = pos.y; }
        else         { body.tree.cx = pos.x; body.tree.cy = pos.y; }
        // send PUT
        await fetch(`${SHEETY_BASE}/${rowId}`, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
      }
    });

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // Toggle Lock/Edit
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    toggleLock.onclick = ()=>{
      if (!canEdit) return;
      locked = !locked;
      network.setOptions({ physics:{enabled:!locked} });
      addBtn.disabled    = locked;
      deleteBtn.disabled = locked;
      toggleLock.textContent = locked ? 'ğŸ”“ Edit Mode' : 'ğŸ”’ View Only';
    };
  })();
  </script>

</body>
</html>



</body>
</html>
